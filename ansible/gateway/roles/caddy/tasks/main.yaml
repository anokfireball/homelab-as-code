- name: Add Caddy xcaddy repository
  ansible.builtin.deb822_repository:
    name: caddy-xcaddy
    types: deb
    uris: https://dl.cloudsmith.io/public/caddy/xcaddy/deb/debian
    suites: any-version
    components:
      - main
    signed_by: https://dl.cloudsmith.io/public/caddy/xcaddy/gpg.key
    state: present
  register: caddy_repo

- name: Update apt cache
  apt:
    update_cache: yes
  when: caddy_repo.changed

- name: check if go is installed
  stat:
    path: /usr/local/go/bin/go
  register: go_binary

- name: get installed go version
  shell: |
    set -o pipefail
    /usr/local/go/bin/go version | awk '{print $3}' | sed 's/go//'
  args:
    executable: /bin/bash
  register: installed_go_version
  when: go_binary.stat.exists
  changed_when: false

- name: remove existing go installation
  file:
    path: /usr/local/go
    state: absent
  when: go_binary.stat.exists and installed_go_version.stdout != go_version

- name: download and extract go
  unarchive:
    src: "https://go.dev/dl/go{{ go_version }}.linux-amd64.tar.gz"
    dest: /usr/local
    remote_src: yes
  when: not go_binary.stat.exists or (go_binary.stat.exists and installed_go_version.stdout != go_version)

- name: add go to PATH
  lineinfile:
    path: /etc/profile
    line: 'export PATH=/usr/local/go/bin:$PATH'
    create: yes

- name: Install xcaddy
  apt:
    name: xcaddy
    state: present

- name: create build directory
  file:
    path: /opt/caddy
    state: directory

- name: check if caddy has been built
  stat:
    path: /opt/caddy/caddy
  register: caddy_binary

- name: get caddy version
  shell: |
    set -o pipefail
    /opt/caddy/caddy version | awk '{print $1}'
  args:
    executable: /bin/bash
  register: built_caddy_version
  when: caddy_binary.stat.exists
  changed_when: false

- name: get cloudflare plugin version
  shell: |
    set -o pipefail
    /opt/caddy/caddy list-modules --versions | grep dns.providers.cloudflare | awk '{print $2}' || true
  args:
    executable: /bin/bash
  register: built_cloudflare_version
  when: caddy_binary.stat.exists
  changed_when: false

- name: get netcup plugin version
  shell: |
    set -o pipefail
    /opt/caddy/caddy list-modules --versions | grep dns.providers.netcup | awk '{print $2}' || true
  args:
    executable: /bin/bash
  register: built_netcup_version
  when: caddy_binary.stat.exists
  changed_when: false

- name: get porkbun plugin version
  shell: |
    set -o pipefail
    /opt/caddy/caddy list-modules --versions | grep dns.providers.porkbun | awk '{print $2}' || true
  args:
    executable: /bin/bash
  register: built_porkbun_version
  when: caddy_binary.stat.exists
  changed_when: false

- name: build caddy
  command: >
    xcaddy build {{ caddy_version }}
    --with github.com/caddy-dns/cloudflare@{{ caddy_cloudflare_version }}
    --with github.com/caddy-dns/netcup@{{ caddy_netcup_version }}
    --with github.com/caddy-dns/porkbun@{{ caddy_porkbun_version }}
  args:
    chdir: /opt/caddy
  environment:
    PATH: "/usr/local/go/bin:{{ ansible_env.PATH }}"
  register: caddy_build
  when: >
    not caddy_binary.stat.exists or
    built_caddy_version.stdout != caddy_version or
    (built_cloudflare_version.stdout | default('')) != caddy_cloudflare_version or
    (built_netcup_version.stdout | default('')) != caddy_netcup_version or
    (built_porkbun_version.stdout | default('')) != caddy_porkbun_version

- name: copy caddy binary
  copy:
    remote_src: true
    src: /opt/caddy/caddy
    dest: /usr/bin/caddy
    mode: '0755'
  register: caddy_copy

- name: make sure caddy group exists
  group:
    name: caddy
    state: present

- name: make sure caddy user exists
  user:
    name: caddy
    group: caddy
    shell: /usr/sbin/nologin
    home: /var/lib/caddy
    system: true
    create_home: true
    state: present

- name: download caddy systemd service file
  get_url:
    url: https://raw.githubusercontent.com/caddyserver/dist/refs/tags/{{ caddy_version }}/init/caddy.service
    dest: /etc/systemd/system/caddy.service
    mode: '0644'
  register: caddy_service

- name: make sure caddy folder exists
  file:
    path: /etc/caddy
    state: directory
    mode: '0755'

- name: obtain secrets
  community.sops.load_vars:
    file: secrets.sops.yaml

- name: template Caddyfile
  template:
    src: Caddyfile.j2
    dest: /etc/caddy/Caddyfile
    mode: '0644'
  register: caddy_template

- name: reload systemd
  systemd:
    daemon_reload: true
  when: caddy_service.changed

- name: ensure caddy service is enabled and started
  systemd:
    name: caddy
    enabled: true
    state: started

- name: restart caddy service if required
  systemd:
    name: caddy
    state: restarted
  when: caddy_copy.changed or caddy_service.changed or caddy_template.changed
