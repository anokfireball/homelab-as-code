apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: nextcloud-postgresql
  namespace: default
spec:
  imageName: ghcr.io/cloudnative-pg/postgresql:17.5-20@sha256:9de626b82bf15bea05ed1172bfc0e45a3687662ec76ac8cbda8f95d02198db39
  instances: 1
  managed:
    services:
      disabledDefaultServices: ["ro", "r"]
    roles:
      - name: backup
        passwordSecret:
          name: postgres-backup-user
        login: true
        superuser: false
        inRoles:
          - pg_read_all_data
  bootstrap:
    initdb:
      database: nextcloud
      owner: nextcloud
      secret:
        name: nextcloud-postgres-user
  storage:
    size: 4Gi
    storageClass: cluster-replicated
---
apiVersion: k8up.io/v1
kind: PreBackupPod
metadata:
  name: nextcloud-database-backup
  namespace: default
  labels:
    backup: nextcloud-database
  annotations:
    k8up.io/backup: "true"
spec:
  backupCommand: sh -c 'PGHOST="$POSTGRES_HOST" PGUSER="$POSTGRES_USER" PGPASSWORD="$POSTGRES_PASSWORD" pg_dumpall --clean'
  pod:
    spec:
      containers:
        - name: nextcloud-database-backup
          image: postgres:16.8-alpine@sha256:114d10708f03b728b5844fa6ff04383c43e6d409967a9cf652d5e5d6fbf5111a
          command:
            - "sleep"
            - "infinity"
          env:
            - name: POSTGRES_HOST
              value: nextcloud-postgresql-rw
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-user
                  key: username
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-backup-user
                  key: password
---
apiVersion: k8up.io/v1
kind: Schedule
metadata:
  name: nextcloud-database
  namespace: default
spec:
  backend:
    repoPasswordSecretRef:
      name: k8up-restic-secrets
      key: restic-password
    s3:
      bucket: Habitat-Giggle9-Composer/nextcloud
  backup:
    labelSelectors:
      - matchLabels:
          backup: nextcloud-database
    schedule: "33 4/6 * * *"
    concurrentRunsAllowed: false
  prune:
    schedule: "3 0 1 * *"
    concurrentRunsAllowed: false
    retention:
      keepHourly: 6
      keepDaily: 14
      keepWeekly: 12
      keepMonthly: 6
      keepYearly: 2
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: nextcloud
  namespace: default
spec:
  interval: 1m
  chart:
    spec:
      chart: nextcloud
      version: 8.2.0
      sourceRef:
        kind: HelmRepository
        name: nextcloud
        namespace: flux-system
  values:
    image:
      flavor: fpm-alpine
    resources:
      requests:
        cpu: 50m
        memory: 150Mi
    # https://github.com/nextcloud/helm/issues/10
    # https://github.com/nextcloud/helm/issues/399
    startupProbe:
      enabled: true
      periodSeconds: 5
      timeoutSeconds: 5
      failureThreshold: 60
      successThreshold: 1
    ingress:
      enabled: true
      className: nginx
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        nginx.ingress.kubernetes.io/affinity: cookie
        nginx.ingress.kubernetes.io/cors-allow-headers: X-Forwarded-For
        nginx.ingress.kubernetes.io/enable-cors: "true"
        nginx.ingress.kubernetes.io/proxy-body-size: 4G
        nginx.ingress.kubernetes.io/server-snippet: |-
          server_tokens off;
          proxy_hide_header X-Powered-By;
          rewrite ^/.well-known/webfinger /index.php/.well-known/webfinger last;
          rewrite ^/.well-known/nodeinfo /index.php/.well-known/nodeinfo last;
          rewrite ^/.well-known/host-meta /public.php?service=host-meta last;
          rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json;
          location = /.well-known/carddav {
              return 301 $scheme://$host/remote.php/dav;
          }
          location = /.well-known/caldav {
              return 301 $scheme://$host/remote.php/dav;
          }
          location = /robots.txt {
              allow all;
              log_not_found off;
              access_log off;
          }
          location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)/ {
              deny all;
          }
          location ~ ^/(?:autotest|occ|issue|indie|db_|console) {
              deny all;
          }
      tls:
        - secretName: nextcloud-tls
          hosts:
            - nextcloud.${SERVICE_DOMAIN}
    phpClientHttpsFix:
      enabled: true
    nextcloud:
      host: nextcloud.${SERVICE_DOMAIN}
      existingSecret:
        enabled: true
        secretName: nextcloud-secrets
        # https://github.com/xperimental/nextcloud-exporter?tab=readme-ov-file#token-authentication
        tokenKey: metrics-token
      trustedDomains:
        - localhost
        - nextcloud
        - nextcloud.${SERVICE_DOMAIN}
      defaultConfigs:
        imaginary.config.php: true
      configs:
        proxy.config.php: |-
          <?php
          $CONFIG = array (
            'trusted_proxies' => array(
              0 => '127.0.0.1',
              1 => '172.16.0.0/24',
              2 => '172.32.0.0/16',
              3 => 'fd08:172:16::/112',
              4 => 'fd08:172:32::/56',
            ),
            'forwarded_for_headers' => array('HTTP_X_FORWARDED_FOR'),
          );
      mail:
        enabled: true
        fromAddress: nextcloud
        domain: ${SERVICE_DOMAIN}
        smtp:
          port: 465
          secure: tls
          authtype: LOGIN
      extraVolumes:
        - name: paperless-consume
          nfs:
            server: 192.168.1.2
            path: /mnt/tank/Dokumente/Paperless/consume
        - name: photo-auto-upload-fabi
          nfs:
            server: 192.168.1.2
            path: /mnt/tank/Bilder/Fabi/Handy
        - name: photo-auto-upload-dani
          nfs:
            server: 192.168.1.2
            path: /mnt/tank/Bilder/Dani/Handy
      extraVolumeMounts:
        - name: paperless-consume
          mountPath: /var/www/html/data/ntauthority/files/consumption/
        - name: photo-auto-upload-fabi
          mountPath: /var/www/html/data/ntauthority/files/auto-upload/
        - name: photo-auto-upload-dani
          mountPath: /var/www/html/data/RedRaven/files/auto-upload/
    imaginary:
      enabled: true
      resources:
        requests:
          cpu: 10m
          memory: 1Gi
    metrics:
      enabled: true
      server: https://nextcloud.${SERVICE_DOMAIN}
      https: true
      serviceMonitor:
        enabled: true
        labels:
          release: kube-prometheus-stack
      resources:
        requests:
          cpu: 10m
          memory: 20Mi
    nginx:
      enabled: true
      ipFamilies:
        - IPv4
        - IPv6
    redis:
      enabled: true
      auth:
        enabled: true
        existingSecret: nextcloud-secrets
        existingSecretPasswordKey: redis-password
      global:
        storageClass: cluster-scratch
      master:
        persistence:
          size: 2Gi
      architecture: standalone
    cronjob:
      enabled: true
      type: cronjob
      cronjob:
        annotations:
          healthcheckSecret: nextcloud-cron
        affinity:
          podAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - nextcloud
                    - key: app.kubernetes.io/component
                      operator: In
                      values:
                        - app
                topologyKey: kubernetes.io/hostname
        securityContext:
          runAsUser: 82
    internalDatabase:
      enabled: false
    externalDatabase:
      enabled: true
      type: postgresql
      host: nextcloud-postgresql-rw
      database: nextcloud
      existingSecret:
        enabled: false
        secretName: nextcloud-postgres-user
        usernameKey: username
        passwordKey: password
    postgresql:
      enabled: false
    service:
      annotations:
        tailscale.com/expose: "true"
        tailscale.com/hostname: homelab-nextcloud
    persistence:
      enabled: true
      storageClass: cluster-replicated
      size: 2Gi
      nextcloudData:
        enabled: true
        annotations:
          k8up.io/backup: "true"
          k8up.io/backup-restic-args: |
            [
              "--exclude", "nextcloud.log",
              "--exclude", "nextcloud.log.*",
              "--exclude", "appdata_*/preview",
              "--exclude", "*/files_external",
              "--exclude", "*/files/auto-upload"
            ]
        labels:
          backup: nextcloud-data
        storageClass: cluster-replicated
        size: 100Gi
---
apiVersion: k8up.io/v1
kind: Schedule
metadata:
  name: nextcloud-data
  namespace: default
spec:
  backend:
    repoPasswordSecretRef:
      name: k8up-restic-secrets
      key: restic-password
    s3:
      bucket: Overshoot-Deviant-Stopwatch1
  backup:
    labelSelectors:
      - matchLabels:
          backup: nextcloud-data
    schedule: "14 1/6 * * *"
    concurrentRunsAllowed: false
  podSecurityContext:
    runAsUser: 82
  prune:
    schedule: "44 0 1 * *"
    concurrentRunsAllowed: false
    retention:
      keepHourly: 6
      keepDaily: 14
      keepWeekly: 12
      keepMonthly: 6
      keepYearly: 2
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nextcloud-grafana-dashboard
  namespace: default
  labels:
    grafana_dashboard: "1"
  annotations:
    grafana_dashboard_folder: nextcloud
data:
  nextcloud.json: |-
    {
      "__inputs": [
        {
          "name": "DS_LOCAL",
          "label": "Prometheus",
          "description": "",
          "type": "datasource",
          "pluginId": "prometheus",
          "pluginName": "Prometheus"
        }
      ],
      "__elements": {},
      "__requires": [
        {
          "type": "grafana",
          "id": "grafana",
          "name": "Grafana",
          "version": "10.2.3"
        },
        {
          "type": "panel",
          "id": "piechart",
          "name": "Pie chart",
          "version": ""
        },
        {
          "type": "datasource",
          "id": "prometheus",
          "name": "Prometheus",
          "version": "1.0.0"
        },
        {
          "type": "panel",
          "id": "stat",
          "name": "Stat",
          "version": ""
        },
        {
          "type": "panel",
          "id": "timeseries",
          "name": "Time series",
          "version": ""
        }
      ],
      "annotations": {
        "list": [
          {
            "$$hashKey": "object:405",
            "builtIn": 1,
            "datasource": {
              "type": "datasource",
              "uid": "grafana"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "target": {
              "limit": 100,
              "matchAny": false,
              "tags": [],
              "type": "dashboard"
            },
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 2,
      "id": null,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 0
          },
          "id": 5,
          "panels": [],
          "title": "Users and Files",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_LOCAL}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 4,
            "x": 0,
            "y": 1
          },
          "id": 12,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "textMode": "auto",
            "wideLayout": true
          },
          "pluginVersion": "10.2.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_LOCAL}"
              },
              "editorMode": "code",
              "expr": "sum by(instance) (nextcloud_active_users_daily_total{instance=\"$instance\"})",
              "instant": false,
              "legendFormat": "__auto",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Daily Active Users",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_LOCAL}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "links": [],
              "mappings": [],
              "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 8,
            "x": 4,
            "y": 1
          },
          "id": 1,
          "links": [],
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "pluginVersion": "10.2.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_LOCAL}"
              },
              "editorMode": "code",
              "expr": "sum by(instance) (nextcloud_users_total{instance=\"$instance\"})",
              "intervalFactor": 1,
              "legendFormat": "total ({{instance}})",
              "metric": "",
              "range": true,
              "refId": "A",
              "step": 900
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_LOCAL}"
              },
              "editorMode": "code",
              "expr": "sum by(instance) (nextcloud_active_users_total{instance=\"$instance\"})",
              "hide": false,
              "intervalFactor": 1,
              "legendFormat": "active ({{instance}})",
              "metric": "",
              "range": true,
              "refId": "B",
              "step": 900
            }
          ],
          "title": "Users",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_LOCAL}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 0,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "links": [],
              "mappings": [],
              "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 12,
            "y": 1
          },
          "id": 11,
          "links": [],
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "pluginVersion": "10.2.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_LOCAL}"
              },
              "editorMode": "code",
              "expr": "sum by(instance) (nextcloud_files_total{instance=\"$instance\"})",
              "intervalFactor": 1,
              "legendFormat": "__auto",
              "metric": "",
              "range": true,
              "refId": "B",
              "step": 900
            }
          ],
          "title": "Files",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 8
          },
          "id": 6,
          "panels": [],
          "title": "Shares",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_LOCAL}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "links": [],
              "mappings": [],
              "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 0,
            "y": 9
          },
          "id": 2,
          "links": [],
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "pluginVersion": "10.2.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_LOCAL}"
              },
              "editorMode": "code",
              "expr": "sum by(type) (nextcloud_shares_total{instance=\"$instance\"})",
              "intervalFactor": 1,
              "legendFormat": "{{type}}",
              "metric": "",
              "range": true,
              "refId": "A",
              "step": 1800
            }
          ],
          "title": "Shares by Type",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_LOCAL}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "links": [],
              "mappings": [],
              "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 12,
            "y": 9
          },
          "id": 3,
          "links": [],
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "pluginVersion": "10.2.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_LOCAL}"
              },
              "editorMode": "code",
              "expr": "sum by(direction) (nextcloud_shares_federated_total{instance=\"$instance\"})",
              "intervalFactor": 1,
              "legendFormat": "{{direction}}",
              "metric": "",
              "range": true,
              "refId": "A",
              "step": 1800
            }
          ],
          "title": "Federated Shares",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 16
          },
          "id": 7,
          "panels": [],
          "title": "Apps",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_LOCAL}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 4,
            "x": 0,
            "y": 17
          },
          "id": 9,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "textMode": "auto",
            "wideLayout": true
          },
          "pluginVersion": "10.2.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_LOCAL}"
              },
              "editorMode": "code",
              "expr": "sum by(instance) (nextcloud_apps_installed_total{instance=\"$instance\"})",
              "instant": false,
              "legendFormat": "__auto",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Installed Apps",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_LOCAL}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "#EAB839",
                    "value": 1
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 4,
            "x": 4,
            "y": 17
          },
          "id": 10,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "textMode": "auto",
            "wideLayout": true
          },
          "pluginVersion": "10.2.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_LOCAL}"
              },
              "editorMode": "code",
              "expr": "sum by(instance) (nextcloud_apps_updates_available_total{instance=\"$instance\"})",
              "instant": false,
              "legendFormat": "__auto",
              "range": true,
              "refId": "A"
            }
          ],
          "title": "Available Updates",
          "type": "stat"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 24
          },
          "id": 8,
          "panels": [],
          "title": "System Information",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_LOCAL}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisBorderShow": false,
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "insertNulls": false,
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "links": [],
              "mappings": [],
              "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green"
                  }
                ]
              },
              "unit": "decbytes"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 0,
            "y": 25
          },
          "id": 4,
          "links": [],
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "pluginVersion": "10.2.3",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_LOCAL}"
              },
              "editorMode": "code",
              "expr": "sum by(instance) (nextcloud_free_space_bytes{instance=\"$instance\"})",
              "interval": "",
              "intervalFactor": 1,
              "legendFormat": "",
              "metric": "",
              "range": true,
              "refId": "A",
              "step": 900
            }
          ],
          "title": "Disk Space Left",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_LOCAL}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                }
              },
              "mappings": []
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 4,
            "x": 12,
            "y": 25
          },
          "id": 13,
          "options": {
            "legend": {
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "values": [
                "percent"
              ]
            },
            "pieType": "pie",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_LOCAL}"
              },
              "editorMode": "code",
              "exemplar": false,
              "expr": "sum by(version) (nextcloud_system_info)",
              "instant": true,
              "legendFormat": "__auto",
              "range": false,
              "refId": "A"
            }
          ],
          "title": "Nextcloud Versions (all instances)",
          "type": "piechart"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_LOCAL}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                }
              },
              "mappings": []
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 4,
            "x": 16,
            "y": 25
          },
          "id": 17,
          "options": {
            "legend": {
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "values": [
                "percent"
              ]
            },
            "pieType": "pie",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_LOCAL}"
              },
              "editorMode": "code",
              "exemplar": false,
              "expr": "sum by(version) (nextcloud_exporter_info)",
              "instant": true,
              "legendFormat": "__auto",
              "range": false,
              "refId": "A"
            }
          ],
          "title": "Exporter Versions (all instances)",
          "type": "piechart"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 32
          },
          "id": 16,
          "panels": [],
          "title": "Environment Information",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_LOCAL}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                }
              },
              "mappings": []
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 4,
            "x": 0,
            "y": 33
          },
          "id": 14,
          "options": {
            "legend": {
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "values": [
                "percent"
              ]
            },
            "pieType": "pie",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_LOCAL}"
              },
              "editorMode": "code",
              "exemplar": false,
              "expr": "sum by(version) (nextcloud_php_info)",
              "instant": true,
              "legendFormat": "__auto",
              "range": false,
              "refId": "A"
            }
          ],
          "title": "PHP Versions (all instances)",
          "type": "piechart"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_LOCAL}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                }
              },
              "mappings": []
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 4,
            "x": 4,
            "y": 33
          },
          "id": 15,
          "options": {
            "legend": {
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "values": [
                "percent"
              ]
            },
            "pieType": "pie",
            "reduceOptions": {
              "calcs": [
                "lastNotNull"
              ],
              "fields": "",
              "values": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_LOCAL}"
              },
              "editorMode": "code",
              "exemplar": false,
              "expr": "sum by(type, version) (nextcloud_database_info)",
              "instant": true,
              "legendFormat": "{{type}} {{version}}",
              "range": false,
              "refId": "A"
            }
          ],
          "title": "Databases (all instances)",
          "type": "piechart"
        }
      ],
      "refresh": "5m",
      "schemaVersion": 39,
      "tags": [
        "prometheus",
        "nextcloud"
      ],
      "templating": {
        "list": [
          {
            "current": {},
            "datasource": {
              "type": "prometheus",
              "uid": "${DS_LOCAL}"
            },
            "definition": "",
            "hide": 0,
            "includeAll": false,
            "label": "Instance",
            "multi": false,
            "name": "instance",
            "options": [],
            "query": "label_values(nextcloud_up, instance)",
            "refresh": 2,
            "regex": "",
            "skipUrlSync": false,
            "sort": 0,
            "tagValuesQuery": "",
            "tagsQuery": "",
            "type": "query",
            "useTags": false
          }
        ]
      },
      "time": {
        "from": "now-30d",
        "to": "now"
      },
      "timepicker": {
        "refresh_intervals": [
          "30s",
          "1m",
          "5m",
          "15m",
          "1h",
          "2h",
          "1d"
        ],
        "time_options": [
          "5m",
          "15m",
          "1h",
          "6h",
          "12h",
          "24h",
          "2d",
          "7d",
          "30d"
        ]
      },
      "timezone": "browser",
      "title": "Nextcloud",
      "uid": "cdae9143-9a17-4d37-87da-d34fb9cfd92f",
      "version": 4,
      "weekStart": ""
    }
